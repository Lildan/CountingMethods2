      PROGRAM LAB3
      IMPLICIT REAL*8(A-H,O-Z)
      DIMENSION Y(10,13),YMAX(10),ERROR(10),PW(100),
     1          FSAVE(20),IWORK(10) 
      COMMON/STCOM1/T,H,HMIN,HMAX,EPS,N,MF,KFLAG,JSTART,MAXORD
      COMMON/STCOM2/HUSED,NQUSED
      COMMON/STCOM3/ML,MU
      COMMON/STCOM4/NSTEP,NFUN,NJAC
      NYDIM=3
      EPS=1.D-2
      KB=0
401   CONTINUE
      N=3
      T=0.0D0
      TEND=1.D0
      Y(1,1)=1.D0
      Y(2,1)=0.D0
      Y(3,1)=0.D0
      H=3.3D-8
      HMAX=TEND
      HMIN=1.D-15
      JSTART=0
      MF=12
      MAXORD=5
      WRITE(0,20) MF,EPS
20    FORMAT(//3X,'MF=',I2/,' EPS='D11.3)
      NSTEP=0
      NFUN=0
      NJAC=0
      DO 30 I=1,N
30    YMAX(I)=1.D0
40    CONTINUE
      CALL STIFF(Y,YMAX,ERROR,PW,FSAVE,IWORK,NYDIM)
      IF(KFLAG.EQ.0)GO TO 60
      WRITE(0,50) KFLAG
50    FORMAT(/'  KFLAG=',I2/)
      STOP
60    CONTINUE
      IF(DABS(TEND-T).LE.1.D-15) GO TO 90
      IF(TEND-T-H) 80,40,40
80    E=TEND-T
      S=E/H
      DO 85 I=1,N
      DO 85 J=1,JSTART
85    Y(I,1)=Y(I,1)+Y(I,J+1)*S**J
      T=T+E
      GO TO 60
90    CONTINUE
      WRITE(0,556) H,T,(Y(I,1),I=1,N)
556   FORMAT(1X,5D16.8)     
      WRITE(0,95) NSTEP,NFUN,NJAC
95    FORMAT(/'  NSTEP=',I4,' NFUN= ',I5,' NJAC=',I4)
      KB=KB+1
      IF(KB.GE.3) GO TO 402
      EPS=EPS*1.D-2
      GO TO 401
402   CONTINUE
      STOP
      END
      SUBROUTINE DIFFUN (N,T,Y,YDOT)
      IMPLICIT REAL*8 (A-H,O-Z)
      DIMENSION Y(1),YDOT(1)
      YDOT(1)=-Y(1)+100000000.D0*Y(3)*(1.D0-Y(1))
      YDOT(2)=-10.D0*Y(2)+30000000.D0*Y(3)*(1.D0-Y(2))
      YDOT(3)=-YDOT(1)-YDOT(2)
      RETURN
      END
      SUBROUTINE PEDERV(N,T,Y,PW,NYDIM)
      IMPLICIT REAL*8 (A-H,O-Z)
      DIMENSION Y(1),PW(1)
      PW(1)=-1.0D0-10.D0*Y(3)
      PW(2)=0.D0
      PW(3)=1.D0+100000000.D0*Y(3)
      PW(NYDIM+1)=0.D0
      PW(NYDIM+2)=-10.D0-30000000.D0*Y(3)
      PW(NYDIM+3)=10.D0+30000000.D0*Y(3)
      N2=NYDIM*2
      PW(N2+1)=100000000.D0*(1.D0-Y(1))
      PW(N2+2)=30000000.D0*(1.D0-Y(2))
      PW(N2+3)=-100000000.D0*(1.D0-Y(1))-30000000.D0*(1.D0-Y(2))
      RETURN
      END
      SUBROUTINE STIFF(Y,YMAX,ERROR,PW,FSAVE,IWORK,NYDIM)
      IMPLICIT REAL*8 (A-H,O-Z)
      LOGICAL EVALJA,CONVER
      COMMON/STCOM1/ T,H,HMIN,HMAX,EPS,N,MF,KFLAG,JSTART,MAXDER
      COMMON/STCOM2/ HUSED,NQUSED
      COMMON/STCOM3/ ML,MU
      COMMON/STCOM4/ NSTEP,NFUN,NJAC
      DIMENSION Y(NYDIM,1),EL(13),TQ(4),YMAX(1)
      DIMENSION ERROR(1),PW(1),FSAVE(1),IWORK(1)
      DATA ANOISE/1.D-15/
      DATA DFLTZR/1.D-50/,MAXITE/3/,MAXFAI/3/
      DATA RMXINI/1.D+4/,RMXNOR/10.D0/,RMXFAI/2.D0/,IDELAY/10/
      DATA RHCORR/0.25D0/,RHERR3/0.1D0/,THRSHL/0.0D0/,RCTEST/0.3D0/
      DATA BIAS1/1.3D0/,BIAS2/1.2D0/,BIAS3/1.4D0/     
      KFLAG=0
      TOLD=T
      IF(JSTART)120,100,200
100   HUSED=0.0D0
      NQUSED=0
      N1=NYDIM+1
      N2=NYDIM+N1
      NSQ=N*NYDIM
      NOLD=N
      NM1=NYDIM-1
      NOML=ML*NYDIM
      MWIDTH=ML+MU+1
      CALL DIFFUN(N,T,Y,FSAVE)
      NFUN=NFUN+1
      DO 110 I=1,N
110   Y(I,2)=FSAVE(I)*H
      NQ=1
      L=2
      IDOUB=L+1
      RMAX=RMXINI
      EPSJ=DSQRT(ANOISE)
      TREND=1.D0
      OLDL0=1.D0
      RC=0.0D0
      HOLD=H
      METH=MF/10
      MITER=MF-10*METH
      MFOLD=MF
      MEO=METH
      MIO=MITER
      EVALJA=.FALSE.
      IF(MITER.NE.0)EVALJA=.TRUE.
      CONVER=.FALSE.
      CALL COSET(METH,NQ,EL,TQ,MAXDER)
      LMAX=MAXDER+1
      EDN=(TQ(1)*EPS)**2
      E=(TQ(2)*EPS)**2
      EUP=(TQ(3)*EPS)**2
      BND=(TQ(4)*EPS)**2
      EPSOLD=EPS
      GOTO 200
120   IF(MF.EQ.MFOLD) GOTO 150
      MEO=METH
      MIO=MITER
      METH=MF/10
      MITER=MF-10*METH
      MFOLD=MF
      IF(MITER.EQ.MIO) GOTO 130
      EVALJA=.FALSE.
      IF(MITER.NE.0) EVALJA=.TRUE.
      CONVER=.FALSE.
130   IF(METH.EQ.MEO)GOTO 150
      IDOUB=L+1
      CALL COSET(METH,NQ,EL,TQ,MAXDER)
      LMAX=MAXDER+1
      RC=RC*EL(1)/OLDL0
      OLDL0=EL(1)
140   EDN=(TQ(1)*EPS)**2
      E=(TQ(2)*EPS)**2
      EUP=(TQ(3)*EPS)**2
      BND=(TQ(4)*EPS)**2
      EPSOLD=EPS
      GOTO 160
150   IF(EPS.NE.EPSOLD)GOTO 140
160   IF(N.EQ.NOLD)GOTO 180
      IDOUB=L+1
      EVALJA=.FALSE.
      IF(MITER.NE.0)EVALJA=.TRUE.
      CONVER=.FALSE.
      IF(MITER.NE.0) NSQ=N*NYDIM
      NOLD=N
180   IF(H.EQ.HOLD)GOTO 200
      RH=H/HOLD
      H=HOLD
      CALL RESCAL(Y,NYDIM,RH,RMAX,RC,L,IDOUB)
200   IF((DABS(RC-1.D0).GT.RCTEST).AND.(MITER.NE.0)) EVALJA=.TRUE.
      T=T+H
      CALL PREDIC(NYDIM,Y,NQ)
220   DO 230 I=1,N
230   ERROR(I)=0.0D0
      ITER=0
      CALL DIFFUN(N,T,Y,FSAVE(N1))
      NFUN=NFUN+1
      IF(.NOT.EVALJA)GOTO 440
      NJAC=NJAC+1
      GOTO (240,260,310,350,380),MITER
240   CALL PEDERV(N,T,Y,PW,NYDIM)
      R=-EL(1)*H
      DO 250 I=1,N
      DO 250 J=I,NSQ,NYDIM
250   PW(J)=PW(J)*R
      GOTO 300
260   SUM=0.0D0
      DO 270 I=1,N
270   SUM=SUM+FSAVE(I+NYDIM)**2
      R0=DABS(H)*DSQRT(SUM)*1.D3*ANOISE
      J1=-NYDIM
      DO 290 J=1,N
      J1=J1+NYDIM
      YJ=Y(J,1)
      R=EPSJ*YMAX(J)
      R=DMAX1(R,R0)
      Y(J,1)=Y(J,1)+R
      FACTOR=-EL(1)*H/R
      CALL DIFFUN(N,T,Y,FSAVE)
      NFUN=NFUN+1
      DO 280 I=1,N
280   PW(I+J1)=(FSAVE(I)-FSAVE(I+NYDIM))*FACTOR
290   Y(J,1)=YJ
300   DO 305 I=1,NSQ,N1
305   PW(I)=PW(I)+1.D0
      EVALJA=.FALSE.
      CONVER=.FALSE.
      RC=1.D0
      CALL MATDEC(N,PW,NYDIM,IWORK)
      GOTO 460
310   R=EL(1)*.1D0
      CONVER=.FALSE.
      DO 320 I=1,N
320   PW(I)=Y(I,1)+R*(FSAVE(I+NYDIM)*H-Y(I,2))
      CALL DIFFUN(N,T,PW,FSAVE)
      NFUN=NFUN+1
      DO 330 I=1,N
      R0=PW(I)-Y(I,1)
      PW(I)=1.0D0
      FACTOR=R0-EL(1)*H*(FSAVE(I)-FSAVE(NYDIM+I))
      FSAVE(I)=R0/R
      IF(DABS(R0).EQ.0.0D0)GOTO 330
      IF(FACTOR.EQ.0.0D0)GOTO 560
      PW(I)=R0/FACTOR
      FSAVE(I)=FSAVE(I)*PW(I)
330   CONTINUE
      EVALJA=.FALSE.
      RC=1.D0
      D=0.0D0
      DO 340 I=1,N
      ERROR(I)=ERROR(I)+FSAVE(I)
      D=D+(FSAVE(I)/YMAX(I))**2
340   FSAVE(I)=Y(I,1)+EL(1)*ERROR(I)
      GOTO 550
350   CALL PEDERV(N,T,Y,PW,NYDIM)
      R=-EL(1)*H
      I1=ML+1
      I2=N
      DO 370 J=1,MWIDTH
      DO 360 I=I1,I2
360   PW(I)=PW(I)*R
      I1=I1+NYDIM
      IF(J.LE.ML) I1=I1-1
      I2=I2+NYDIM
      IF(J.GT.ML) I2=I2-1
370   CONTINUE
      GOTO 420
380   SUM=0.0D0
      DO 390 I=1,N
390   SUM=SUM+DABS(FSAVE(I+NYDIM))
      R0=DABS(H)*SUM*1.D+3*ANOISE
      J1=NOML
      DO 410 J=1,N
      J1=J1+NYDIM
      YJ=Y(J,1)
      R=EPSJ*YMAX(J)
      R=DMAX1(R,R0)
      Y(J,1)=Y(J,1)+R
      FACTOR=-EL(1)*H/R
      CALL DIFFUN(N,T,Y,FSAVE)
      NFUN=NFUN+1
      I1=MAX0(J-MU,1)
      I2=MIN0(J+ML,N)
      DO 400 I=I1,I2
400   PW(J1-NM1*I)=(FSAVE(I)-FSAVE(I+NYDIM))*FACTOR
410   Y(J,1)=YJ
420   DO 430 I=1,N
430   PW(NOML+I)=PW(NOML+I)+1.D0
      EVALJA=.FALSE.
      CONVER=.FALSE.
      RC=1.D0
      CALL BANMAT(N,ML,MU,1,0,PW,NYDIM,FSAVE,N,DET,IWORK)
      GOTO 520
440   IF(MITER.NE.0) GO TO (460,460,490,520,520),MITER
      D=0.0D0
      DO 450 I=1,N
      R=H*FSAVE(I+NYDIM)-Y(I,2)
      D=D+((R-ERROR(I))/YMAX(I))**2
      FSAVE(I)=Y(I,1)+EL(1)*R
450   ERROR(I)=R
      GOTO 550
460   DO 470 I=1,N
470   FSAVE(I+NYDIM)=FSAVE(I+NYDIM)*H-Y(I,2)-ERROR(I)
      CALL MATSOL(N,PW,NYDIM,IWORK,FSAVE(N1),FSAVE)
      D=0.0D0
      DO 480 I=1,N
      ERROR(I)=ERROR(I)+FSAVE(I)
      D=D+(FSAVE(I)/YMAX(I))**2
480   FSAVE(I)=Y(I,1)+EL(1)*ERROR(I)
      GOTO 550
490   DO 500 I=1,N
500   FSAVE(I)=PW(I)*(FSAVE(I+NYDIM)*H-Y(I,2)-ERROR(I))
      D=0.0D0
      DO 510 I=1,N
      ERROR(I)=ERROR(I)+FSAVE(I)
      D=D+(FSAVE(I)/YMAX(I))**2
510   FSAVE(I)=Y(I,1)+EL(1)*ERROR(I)
      GOTO 550
520   DO 530 I=1,N
530   FSAVE(I)=FSAVE(I+NYDIM)*H-Y(I,2)-ERROR(I)
      CALL BANMAT(N,ML,MU,0,1,PW,NYDIM,FSAVE,N,DET,IWORK)
      D=0.0D0
      DO 540 I=1,N
      ERROR(I)=ERROR(I)+FSAVE(I)
      D=D+(FSAVE(I)/YMAX(I))**2
540   FSAVE(I)=Y(I,1)+EL(1)*ERROR(I)
550   IF (ITER.NE.0) TREND=DMAX1(0.9D0*TREND,D/D1)
      IF((D*DMIN1(1.D0,2.D0*TREND)).LE.BND) GOTO 590
      D1=D
      ITER=ITER+1
      IF(ITER.EQ.MAXITE)GOTO 560
      CALL DIFFUN(N,T,FSAVE,FSAVE(N1))
      NFUN=NFUN+1
      GOTO 440
560   IF(.NOT.CONVER)GOTO 570
      EVALJA=.TRUE.
      GOTO 220
570   T=TOLD
      RMAX=RMXFAI
      DO 580 J1=1,NQ
      DO 580 J2=J1,NQ
      J=NQ-J2+J1
      DO 580 I=1,N
580   Y(I,J)=Y(I,J)-Y(I,J+1)
      IF(DABS(H).LE.(HMIN*1.00001D0)) GOTO 820
      RH=RHCORR
      CALL RESCAL(Y,NYDIM,RH,RMAX,RC,L,IDOUB)
      GOTO 200
590   D=0.0D0
      DO 600 I=1,N
600   D=D+(ERROR(I)/YMAX(I))**2
      IF(MITER.NE.0) CONVER=.TRUE.
      NSTEP=NSTEP+1
      IF(D.LE.E) GOTO 670
      KFLAG=KFLAG-1
      T=TOLD
      DO 610 J1=1,NQ
      DO 610 J2=J1,NQ
      J=NQ-J2+J1
      DO 610 I=1,N
610   Y(I,J)=Y(I,J)-Y(I,J+1)
      RMAX=RMXFAI
      IF(DABS(H).LE.(HMIN*1.00001D0)) GOTO 810
      IF(KFLAG.LE.-MAXFAI)GOTO 650
      PR2=1.D0/(((D/E)**(.5D0/DBLE(L)))*BIAS2+DFLTZR)
      IF(NQ.EQ.1) GOTO 630
      SUM=0.0D0
      DO 620 I=1,N
620   SUM=SUM+(Y(I,L)/YMAX(I))**2
      PR1=1.D0/(((SUM/EDN)**(.5D0/DBLE(NQ)))*BIAS1+DFLTZR)
      IF(PR1.GT.PR2)GOTO 640
630   RH=PR2
      CALL RESCAL(Y,NYDIM,RH,RMAX,RC,L,IDOUB)
      GOTO 200
640   L=NQ
      NQ=NQ-1
      RH=PR1
      CALL COSET(METH,NQ,EL,TQ,MAXDER)
      LMAX=MAXDER+1
      RC=RC*EL(1)/OLDL0
      OLDL0=EL(1)
      EDN=(TQ(1)*EPS)**2
      E=(TQ(2)*EPS)**2
      EUP=(TQ(3)*EPS)**2
      BND=(TQ(4)*EPS)**2
      CALL RESCAL(Y,NYDIM,RH,RMAX,RC,L,IDOUB)
      GOTO 200
650   RH=RHERR3
      RH=DMAX1(HMIN/DABS(H),RH)
      H=H*RH
      CALL DIFFUN(N,T,Y,FSAVE)
      NFUN=NFUN+1
      DO 660 I=1,N
660   Y(I,2)=H*FSAVE(I)
      IF(MITER.NE.0)EVALJA=.TRUE.
      IDOUB=IDELAY
      IF(NQ.EQ.1)GOTO 200
      NQ=1
      L=2
      CALL COSET(METH,NQ,EL,TQ,MAXDER)
      LMAX=MAXDER+1
      OLDL0=EL(1)
      EDN=(TQ(1)*EPS)**2
      E=(TQ(2)*EPS)**2
      EUP=(TQ(3)*EPS)**2
      BND=(TQ(4)*EPS)**2
      GOTO 200
670   HUSED=H
      NQUSED=NQ
      KFLAG=0
      DO 680 J=1,L
      DO 680 I=1,N
680   Y(I,J)=Y(I,J)+EL(J)*ERROR(I)
      IF(IDOUB.EQ.1)GOTO 700
      IDOUB=IDOUB-1
      IF((IDOUB.GT.1).OR.(NQ.EQ.MAXDER))GOTO 840
      DO 690 I=1,N
690   Y(I,LMAX)=ERROR(I)
      GOTO 840
700   PR3=DFLTZR
      IF(NQ.EQ.MAXDER)GOTO 720
      SUM=0.0D0
      DO 710 I=1,N
710   SUM=SUM+((ERROR(I)-Y(I,LMAX))/YMAX(I))**2
      PR3=1.D0/(((SUM/EUP)**(.5D0/DBLE(L+1)))*BIAS3+DFLTZR)
720   PR2=1.D0/(((D/E)**(.5D0/DBLE(L)))*BIAS2+DFLTZR)
      PR1=DFLTZR
      IF(NQ.EQ.1)GOTO 740
      SUM=0.0D0
      DO 730 I=1,N
730   SUM=SUM+(Y(I,L)/YMAX(I))**2
      PR1=1.D0/(((SUM/EDN)**(.5D0/DBLE(NQ)))*BIAS1+DFLTZR)
740   IF((PR3.GT.PR1).AND.(PR3.GT.PR2)) GOTO 760
      IF(PR1.GT.PR2)GOTO 750
      RH=PR2
      IF(RH-THRSHL) 800,790,790
750   NEWQ=NQ-1
      RH=PR1
      IF(RH-THRSHL) 800,780,780
760   NEWQ=L
      RH=PR3
      IF(RH.LT.THRSHL)GOTO 800
      DO 770 I=1,N
770   Y(I,NEWQ+1)=ERROR(I)*EL(L)/DBLE(L)
780   NQ=NEWQ
      L=NQ+1
      CALL COSET(METH,NQ,EL,TQ,MAXDER)
      LMAX=MAXDER+1
      RC=RC*EL(1)/OLDL0
      OLDL0=EL(1)
      EDN=(TQ(1)*EPS)**2
      E=(TQ(2)*EPS)**2
      EUP=(TQ(3)*EPS)**2
      BND=(TQ(4)*EPS)**2
790   CALL RESCAL(Y,NYDIM,RH,RMAX,RC,L,IDOUB)
      GOTO 830
800   IDOUB=IDELAY
      GOTO 840
810   KFLAG=-1
      GOTO 840
820   KFLAG=-2
      GOTO 840
830   RMAX=RMXNOR
840   HOLD=H
      JSTART=NQ
      RETURN
      END

      SUBROUTINE MATDEC(N,A,IA,IROW)
      IMPLICIT REAL*8 (A-H,O-Z)
      DIMENSION A(IA,1),IROW(1)
      IF (N.GT.1) GOTO 1
      A(1,1)=1.D0/A(1,1)
      IROW(1)=1
      RETURN
1     DO 2 I=1,N
2     IROW(I)=I
      N11=N-1
      DO 7 I=1,N11
      BIG=0.0D0
      DO 3 J=I,N
      JR=IROW(J)
      SIZE=DABS(A(JR,I))
      IF (SIZE.LE.BIG) GOTO 3
      BIG=SIZE
      IPIV=J
3     CONTINUE
      IF (IPIV.EQ.I) GOTO 4
      L=IROW(I)
      IROW(I)=IROW(IPIV)
      IROW(IPIV)=L
4     IR=IROW(I)
      PIVOT=1.D0/A(IR,I)
      A(IR,I)=PIVOT
      I11=I+1
      DO 6 J=I11,N
      JR=IROW(J)
      FACT=PIVOT*A(JR,I)
      A(JR,I)=FACT
      DO 5 K=I11,N
5     A(JR,K)=A(JR,K)-FACT*A(IR,K)
6     CONTINUE
7     CONTINUE
      NR=IROW(N)
      A(NR,N)=1.D0/A(NR,N)
      RETURN
      END

      SUBROUTINE RESCAL (Y,NYDIM,RH,RMAX,RC,L,IDOUB)
      IMPLICIT REAL*8 (A-H,O-Z)
      DIMENSION Y(NYDIM,1)
      COMMON/STCOM1/ T,H,HMIN,HMAX,EPS,N,MF,KFLAG,JSTART,MAXDER
      RH=DMAX1(RH,HMIN/DABS(H))
      RH=DMIN1(RH,HMAX/DABS(H),RMAX)
      R1=1.D0
      DO 180 J=2,L
      R1=R1*RH
      DO 180 I=1,N
180   Y(I,J)=Y(I,J)*R1
      H=H*RH
      RC=RC*RH
      IDOUB=L+1
      RETURN
      END

      SUBROUTINE MATSOL(N,A,IA,IROW,Y,X)
      IMPLICIT REAL*8 (A-H,O-Z)
      DIMENSION A(IA,1),IROW(1),Y(1),X(1)
      IF (N.GT.1) GOTO 8
      X(1)=Y(1)*A(1,1)
      RETURN
8     IR=IROW(1)
      X(1)=Y(IR)
      DO 10 I=2,N
      IR=IROW(I)
      S=Y(IR)
      I10=I-1
      DO 9 K=1,I10
9     S=S-A(IR,K)*X(K)
10    X(I)=S
      X(N)=X(N)*A(IR,N)
      DO 12 I=2,N
      J=N-I+1
      JR=IROW(J)
      S=X(J)
      J11=J+1
      DO 11 K=J11,N
11    S=S-A(JR,K)*X(K)
12    X(J)=S*A(JR,J)
      RETURN
      END
      SUBROUTINE PREDIC(NYDIM,Y,NQ)
      IMPLICIT REAL*8 (A-H,O-Z)
      DIMENSION Y(NYDIM,1)
      COMMON/STCOM1/   T,H,HMIN,HMAX,EPS,N,MF,KFLAG,JSTART,MAXDER
      DO 210 J1=1,NQ
      DO 210 J2=J1,NQ
      J=NQ-J2+J1
      DO 210 I=1,N
210   Y(I,J)=Y(I,J)+Y(I,J+1)
      RETURN
      END
      SUBROUTINE BANMAT(IN,L1,L2,NT,IM,A,IA,Y,IY,DET,INT)
      IMPLICIT REAL*8 (A-H,O-Z)
      DIMENSION A(IA,IA),Y(IY,IY),INT(IN)
      DATA XND/1777.0D+16/
      N=IN
      L=IM
      ML=L1
      MU=L2
      LL=ML+MU+1
      IF (N.LE.1.OR.IA.LT.N.OR.L1.LE.0.OR.L2.LE.0) GOTO 23
      LU=LL+1
      LP=LL+ML
      N1=N-1
      IF (NT.NE.1) GOTO 9
      SN=1.0D0
      DO 3 I=1,ML
      II=MU+I
      K=ML+1-I
      DO 1 J=1,II
1     A(I,J)=A(I,J+K)
      K=II+1
      DO 2 J=K,LL
2     A(I,J)=0.0D0
3     CONTINUE
      DO 8 NR=1,N1
      NP=NR+1
      LR=NR+ML
      IF (LR.GT.N) LR=N
      LC=NR+LL-1
      IF (LC.GT.N) LC=N
      KK=LC-NR
      MX=NR
      XM=DABS(A(NR,1))
      DO 4 I=NP,LR
      IF (DABS(A(I,1)).LE.XM) GOTO 4
      MX=I
      XM=DABS(A(I,1))
4     CONTINUE
      INT(NR)=MX
      IF (MX.EQ.NR) GOTO 6
      DO 5 I=1,LL
      XX=A(NR,I)
      A(NR,I)=A(MX,I)
5     A(MX,I)=XX
      SN=-SN
6     XM=A(NR,1)
      IF (XM.EQ.0.0D0) GOTO 18
      XM=-1.D0/XM
      DO 7 I=NP,LR
      J=LL+I-NR
      XX=A(I,1)*XM
      A(NR,J)=XX
      CALL ADDVEC(KK,XX,A(NR,2),IA,A(I,2),IA,A(I,1),IA)
7     A(I,LL)=0.0D0
8     CONTINUE
      IF (A(N,1).EQ.0.0D0) SN=0.0D0
9     DET=SN
      IF (IM.EQ.0) RETURN
      DO 13 NR=1,N1
      NP=NR+1
      LR=NR+ML
      IF(LR.GT.N) LR=N
      KK=LR-NR
      IF(A(NR,1).EQ.0.0D0) GOTO 18
      IF(INT(NR).EQ.NR) GOTO 11
      J=INT(NR)
      DO 10 I=1,L
      XX=Y(NR,I)
      Y(NR,I)=Y(J,I)
10    Y(J,I)=XX
11    DO 12 I=1,L
12    CALL ADDVEC(KK,Y(NR,I),A(NR,LU),IA,Y(NP,I),1,Y(NP,I),1)
13    CONTINUE
      XM=A(N,1)
      NR=N
      IF(XM.EQ.0.0D0) GOTO 18
      XM=1.D0/XM
      DO 14 I=1,L
14    Y(N,I)=Y(N,I)*XM
      NS=1
15    DO 17 NB=NS,N1
      NR=N-NB
      NP=NR+1
      LC=NR+LL-1
      IF (LC.GT.N) LC=N
      KK=LC-NR
      DO 16 I=1,L
16    Y(NR,I)=(Y(NR,I)-DOTPRO(KK,A(NR,2),IA,Y(NP,I),1))/A(NR,1)
17    CONTINUE
      RETURN
18    J=NR-1
      DET=0.0D0
      DO 22 I=1,L
      XX=0.0D0
      IF(J.EQ.0) GOTO 20
      DO 19 K=1,J
19    IF (DABS(Y(K,I)).GT.XX)  XX=DABS(Y(K,I))
20    XX=XX*1.D-12
      DO 21 K=NR,N
      IF (DABS(Y(K,I)).GT.XX) GOTO 23
21    Y(K,I)=0.0D0
22    Y(NR,I)=1.0D0
      NS=N-NR+1
      GOTO 15
23    DET=XND
      RETURN
      END
      SUBROUTINE ADDVEC(KK,XX,A,IA,B,IB,C,IC)
      IMPLICIT REAL*8 (A-H,O-Z)
      DIMENSION A(1),B(1),C(1)
      X=XX
      K=KK
      JA=1
      JB=1
      JC=1
      DO 1 I=1,K
      C(JC)=B(JB)+X*A(JA)
      JA=JA+IA
      JB=JB+IB
1     JC=JC+IC
      RETURN
      END
      DOUBLE PRECISION FUNCTION DOTPRO(KK,A,IA,B,IB)
      IMPLICIT REAL*8 (A-H,O-Z)
      DIMENSION A(1),B(1)
      K=KK
      S=0.0D0
      JA=1
      JB=1
      DO 1 I=1,K
      S=S+A(JA)*B(JB)
      JA=JA+IA
1     JB=JB+IB
      DOTPRO=S
      RETURN
      END

      SUBROUTINE COSET(METH,NQ,EL,TQ,MAXDER)
      IMPLICIT REAL*8(A-H,O-Z)
      DIMENSION PERTST(12,2,3),EL(13),TQ(4)
      DATA PERTST/1.,1.,2.,1.,.3158,.07407,.01391,.002182,
     1    .0002945,.00003492,.000003692,.0000003524,
     2    1.,1.,.5,.16666667,.041666667,1.,1.,1.,1.,1.,1.,1.,
     3    2.,12.,24.,37.89,53.33,70.08,87.97,106.9,
     4    126.7,147.4,168.8,191.0,
     5    2.,4.5,7.3333333,10.416667,13.7,1.,1.,1.,1.,1.,1.,1.,
     6    12.0,24.0,37.89,53.33,70.08,87.97,106.9,
     7    126.7,147.4,168.8,194.0,1.,
     8    3.,6.,9.1666667,12.5,1.,1.,1.,1.,1.,1.,1.,1./
      EL(2)=1.0D0
      GO TO (1,2),METH
1     MAXDER=MIN0(MAXDER,12)
      GO TO (101,102,103,104,105,106,107,108,109,110,111,112),NQ
2     MAXDER=MIN0(MAXDER,5)
      GO TO (201,202,203,204,205),NQ
101   EL(1)=1.0D0
      GO TO 900
102   EL(1)=0.5D0
      EL(3)=0.5D0
      GO TO 900
103   EL(1)=0.4166666666666667D0
      EL(3)=0.75D0
      EL(4)=0.1666666666666667D0
      GO TO 900
104   EL(1)=0.375D0
      EL(3)=0.9166666666666667D0
      EL(4)=0.3333333333333333D0
      EL(5)=0.4166666666666667D-01
      GO TO 900
105   EL(1)=0.3486111111111111D0
      EL(3)=0.1041666666666667D 01
      EL(4)=0.4861111111111111D0
      EL(5)=0.1041666666666667D0
      EL(6)=0.8333333333333333D-02
      GO TO 900
106   EL(1)=0.3298611111111111D0
      EL(3)=0.1141666666666667D 01
      EL(4)=0.625D0
      EL(5)=0.1770833333333333D0
      EL(6)=0.025D0
      EL(7)=0.1388888888888889D-02
      GO TO 900
107   EL(1)=0.3155919312169312D0
      EL(3)=0.1225D 01
      EL(4)=0.7518518518518519D0
      EL(5)=0.2552083333333333D0
      EL(6)=0.4861111111111111D-01
      EL(7)=0.4861111111111111D-02
      EL(8)=0.1984126984126984D-03
      GO TO 900
108   EL(1)=0.3042245370370370D0
      EL(3)=0.1296428571428571D 01
      EL(4)=0.8685185185185185D0
      EL(5)=0.3357638888888889D0
      EL(6)=0.7777777777777778D-01
      EL(7)=0.1064814814814815D-01
      EL(8)=0.7936507936507937D-03
      EL(9)=0.2480158730158730D-04
      GO TO 900
109   EL(1)=0.2948680004409171D0
      EL(3)=0.1358928571428571D 01
      EL(4)=0.9765542328042328D0
      EL(5)=0.4171875D0
      EL(6)=0.1113541666666667D0
      EL(7)=0.01875D0
      EL(8)=0.1934523809523810D-02
      EL(9)=0.1116071428571429D-03
      EL(10)=0.2755731922398589D-05
      GO TO 900
110   EL(1)=0.2869754464285714D0
      EL(3)=0.1414484126984127D 01
      EL(4)=0.1077215608465608D 01
      EL(5)=0.4985670194003527D0
      EL(6)=0.1484375D0
      EL(7)=0.2906057098765432D-01
      EL(8)=0.3720238095238095D-02
      EL(9)=0.2996858465608466D-03
      EL(10)=0.1377865961199295D-04
      EL(11)=0.2755731922398589D-06
      GO TO 900
111   EL(1)=0.2801895964439367D0
      EL(3)=0.1464484126984127D 01
      EL(4)=0.1171514550264550D 01
      EL(5)=0.5793581900352734D0
      EL(6)=0.1883228615520282D0
      EL(7)=0.4143036265432099D-01
      EL(8)=0.6211144179894180D-02
      EL(9)=0.6252066798941799D-03
      EL(10)=0.4041740152851264D-04
      EL(11)=0.1515652557319224D-05
      EL(12)=0.2505210838544172D-07
      GO TO 900
112   EL(1)=0.2742655400315991D0
      EL(3)=0.1509938672438672D 01
      EL(4)=0.1260271164021164D 01
      EL(5)=0.6592341820987654D0
      EL(6)=0.2304580026455026D0
      EL(7)=0.5569724610523222D-01
      EL(8)=0.9439484126984127D-02
      EL(9)=0.1119274966931217D-02
      EL(10)=0.9093915343915344D-04
      EL(11)=0.4822530864197531D-05
      EL(12)=0.1503126503126503D-06
      EL(13)=0.2087675698786810D-08
      GO TO 900
201   EL(1)=1.0D0
      GO TO 900
202   EL(1)=0.6666666666666667D0
      EL(3)=0.3333333333333333D0
      GO TO 900
203   EL(1)=0.5454545454545455D0
      EL(3)=EL(1)
      EL(4)=0.9090909090909091D-01
      GO TO 900
204   EL(1)=0.48D0
      EL(3)=0.7D0
      EL(4)=0.2D0
      EL(5)=0.2D-01
      GO TO 900
205   EL(1)=0.4379562043795620D0
      EL(3)=0.8211678832116788D0
      EL(4)=0.3102189781021898D0
      EL(5)=0.5474452554744526D-01
      EL(6)=0.3649635036496350D-02
900   DO 910 K=1,3
910   TQ(K)=PERTST(NQ,METH,K)
      TQ(4)=0.5D0/DBLE(NQ+2)
      RETURN
      END
